<!DOCTYPE html>
<html>
<head>
  <title>Voice Broadcaster</title>
</head>
<body>
  <h2>🎤 Voice Broadcast Mic</h2>
  <button id="startBtn">Start Broadcasting</button>
  <p id="status">Status: Not Connected</p>

  <script>
    const status = document.getElementById("status");
    const ws = new WebSocket("wss://voice-stream-server2.onrender.com");

    let mediaRecorder;

    ws.onopen = () => {
      console.log("✅ WebSocket connected");
      status.innerText = "Status: Connected to Server";

      document.getElementById("startBtn").onclick = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          console.log("🎙️ Microphone permission granted");
          status.innerText = "Status: Mic access granted";

          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start(200); // record every 200ms

          mediaRecorder.onstart = () => {
            console.log("🎤 Recording started");
            status.innerText = "Status: Recording started";
          };

          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {
              ws.send(event.data);
              console.log("📤 Sent audio chunk");
            }
          };
        } catch (err) {
          console.error("❌ Mic access denied or error:", err);
          status.innerText = "❌ Error: Mic access denied or not supported";
        }
      };
    };

    ws.onerror = (err) => {
      console.error("❌ WebSocket Error", err);
      status.innerText = "❌ WebSocket connection failed";
    };
  </script>
</body>
</html>
