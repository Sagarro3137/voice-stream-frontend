<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Mic Broadcaster</title>
</head>
<body>
  <h2>🎙️ Broadcasting Voice...</h2>
  <p id="status">Waiting...</p>

  <script>
    const status = document.getElementById("status");

    const socket = new WebSocket("wss://voice-stream-server2.onrender.com");

    socket.addEventListener("open", () => {
      status.innerText = "✅ Connected to server!";
      socket.send("broadcaster");

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          const mediaRecorder = new MediaRecorder(stream, {
            mimeType: "audio/webm"
          });

          mediaRecorder.addEventListener("dataavailable", (event) => {
            if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
              socket.send(event.data);
            }
          });

          mediaRecorder.start(250); // Send chunks every 250ms
        })
        .catch(err => {
          status.innerText = "❌ Microphone access denied.";
          console.error(err);
        });
    });

    socket.addEventListener("close", () => {
      status.innerText = "❌ Disconnected from server.";
    });

    socket.addEventListener("error", (error) => {
      status.innerText = "❗ WebSocket error.";
      console.error("WebSocket error:", error);
    });
  </script>
</body>
</html>
